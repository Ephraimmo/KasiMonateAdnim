<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  
</head>

<style>
  img{
    width: 60px;
    height: 70px;
  }
  
</style>
<style>
  .toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
  }
  .toast-header {
    background-color: #28a745;
    color: #fff;
  }
  .toast-info .toast-header {
    background-color: #17a2b8;
  }
  .toast-danger .toast-header {
    background-color: #dc3545;
  }
  .toast-body {
    background-color: #f8f9fa;
  }
  .toast-success .toast-body {
    background-color: #f8f9fa;
  }
</style>

<style>
  
  .border {
    border-width:3px !important;
}

tfoot tr, thead tr {
	background: lightblue;
}
tfoot td {
	font-weight:bold;
}
</style>

<body>

        <!-- Toast Container -->
  <div id="toastContainer" class="toast-container" style="width: 20%;"></div>

        <div class="col-12">
            <!-- Button trigger modal -->
            <div class="row">
                <div class="col-4">
                    <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Add User</button>
                </div>
    
                <div class="col-4"></div>
            </div>
        </div>

        <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" id="mi-modal">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Confirmar</h4>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" id="modal-btn-si">Si</button>
                <button type="button" class="btn btn-primary" id="modal-btn-no">No</button>
              </div>
            </div>
          </div>
        </div>
    
  
    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Add New User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <img src="img/1.jpg" class="modal-img" alt="modal img" hidden>
   
            <form class="row g-3 needs-validation" id="myForm" onsubmit="return false" novalidate>
              <div class="row">

                <div class="col-md-12">
                  <label class="mb-0" for="Select Branche">Select Branche</label> <br>
                  <select class="form-select" name="Select Branche" id="SelectCategory" required>
                    <option value="">No Branche</option>
                  </select>
                </div>
                
                <div class="col-md-12">
                  <label for="Username">Username</label>
                  <input type="text" class="form-control" name="Username" id = "ProductName" required>
                </div>
                
                <div class="col-md-12">
                  <label for="Password">Password</label>
                  <input type="text" name="Password"  id = "Meta_TitleProduct" placeholder="Enter meta title" class="form-control" required>
                </div>
 
                  <div class="col-md-1"></div>
 
                  <div class="col-md-3">
                    <label for="Adnim">Adnim</label> <br> 
                    <input type="checkbox" name="Adnim" id="Status_Product">
                  </div>
 
                  <div class="col-md-2">
                    <label for="delivery">delivery</label> <br> 
                    <input type="checkbox" name="delivery" id="Trending_Product">
                  </div>
                
 
                <div class="row">
 
                  <div class="col-md-10">
                    
                    <div id = "ControlDiv" > 
                      <div class="row">
                        <div id = "imagesDiv" > </div>
                      </div>
                      
                        
                      </progress> <label id="progress"> </label>
                    </div>
                  </div>
                </div>
 
              
                <div class="col-md-10" id = "showButton">
                  
 
                  <button type="button" id = "selimgsbtn" class="btn btn-primary" >Select Images</button>
                  <button type="button" id = "addproductbtn" class="btn btn-primary" >Upload Images</button>
                 </div>
                
                <input hidden id = "namebox" type = "text"> <label hidden id = "extlab"> </label> <br><br>
                
             </div>
 
             <div class="col-6"><button hidden id="Submitform" class="btn btn-primary" type="submit" ></button></div>
                  
            </form> 
              
         </div>
          <div class="modal-footer">
            
            <button type="button" class="btn btn-primary" >Close</button>
            <button type="button" id = "CloseButton" class=" Save btn btn-primary" >Add</button>
          </div>
        </div>
      </div>
    </div>

    <table id="example" class="table table-striped" style="width:100%">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Name</th>
                <th scope="col">Description</th>
                <th scope="col">Image</th>
                <th scope="col">Srtatus</th>
                <th scope="col">Srtatus</th>
                <th scope="col">Action</th>
              </tr>
        </thead>
        <tbody id = "addRow">
            
            
        </tbody>
        <tfoot>
            <tr>
                <th>Name</th>
                <th>Position</th>
                <th>Office</th>
                <th>Age</th>
                <th>Start date</th>
                <th>Start date</th>
                <th>Salary</th>
            </tr>
        </tfoot>
    </table>
    
</body>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  
  // Your web app's Firebase configuration
  const firebaseConfig = {
  // ...
  apiKey: "AIzaSyDibpkuzUookkbMVIoHqe_rYu1umY1qF-4",
  authDomain: "data-b93ed.firebaseapp.com",
  databaseURL: "https://data-b93ed-default-rtdb.firebaseio.com",
  projectId: "data-b93ed",
  storageBucket: "data-b93ed.appspot.com",
  messagingSenderId: "218236841715",
  appId: "1:218236841715:web:e96bfd3174b08438701186"
};

  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  
  import {getDatabase, set,get, ref , child, update}                                                                            from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";
  import {getStorage,ref as sRef,uploadBytesResumable,getDownloadURL, deleteObject }                                                          from "https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js";
  import { getFirestore, doc, getDoc, getDocs , setDoc ,collection , onSnapshot , addDoc, updateDoc, deleteDoc , deleteField  } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
  
  const realdb = getDatabase();
  const db     = getFirestore();
  
  
  //---------------------------------------------------------------------------------------------
  var Files           = [];
  var files           = [];
  var FileReaders     = [];
  var reader          = new FileReader();
  var ImageLinksArray = [];
  var count           = 0;
  var progresValue    = [];
  var oldImageUrl     = [];
  var productPosition = 0;
  var countLastPosition = 0;
  var ProductUploadImage = [];
  var updateImageExtention = '';
  var updateImageName      = '';
  var checkEditButtonClick = false;
  var reload = false;
  var imageToDelete = [];
  var docPath = 0;
  
    const imgdiv     = document.getElementById("imagesDiv");
    const selBtn     = document.getElementById("selimgsbtn");
    const addBtn     = document.getElementById("addproductbtn");
  
    const name                     = document.getElementById("ProductName");
    const SubStore                 = document.getElementById("SelectCategory");

    const ProductShortDescription  = document.getElementById("ProductShortDescription");
    const ProductDescription       = document.getElementById("ProductDescription");
    const ProductOriginal          = document.getElementById("ProductOriginal");
    const ProductSelling           = document.getElementById("ProductSelling");
    const ProductQuantity          = document.getElementById("ProductQuantity");
    const Status_Product           = document.getElementById("Status_Product");
    const Trending_Product         = document.getElementById("Trending_Product");
    const Meta_TitleProduct        = document.getElementById("Meta_TitleProduct");
    const Meta_Description_Product = document.getElementById("Meta_Description_Product");
    const Meta_Keywords_Product    = document.getElementById("Meta_Keywords_Product");

    //addEventListener for any button
    document.addEventListener("click",function (e){
      
      //add recoed to dataBase
      if (e.target.innerHTML == "Add User")
      {
        name                    .value = "";
        Meta_TitleProduct       .value = "";
        Status_Product          .value = "";
        Trending_Product        .value = "";
        //If (document.getElementById('imgNo0').src != null)
          //document.getElementById('imgNo0').src = '';
        //removeAndShowElement(['showButton'],'block',false);
        
      }else if (e.target.innerHTML == "Add")
      {
        if (name.value == "")
            {
              document.getElementById("Submitform").click();
              return;
            }
        AddProduct(sessionStorage.getItem("CompanyName"));
        $('#staticBackdrop').modal('hide');
        document.getElementById("myForm").reset();
      }else if (e.target.innerHTML == "Edit")
      {
        removeAndShowElement(['showButton'],'none',false);
        getDoumentWithGivenID("UsersSubAdnim",e.target.id);
        productPosition = e.target.id;
        document.getElementById("CloseButton").innerHTML = "Update";
        checkEditButtonClick = true;

      }else if (e.target.innerHTML == "Update")
      {

        if (name.value == "")
        {
          document.getElementById("Submitform").click();
          return;
        }else if (Meta_TitleProduct.value == "")
        {
          document.getElementById("Submitform").click();
          return;
        }
        
        updateDoument_GivenID("UsersSubAdnim",productPosition);
        document.getElementById("CloseButton").innerHTML = "Add";
        removeAndShowElement(['newId0'],"",true);
        removeAndShowElement(['showButton'],'block',false);
        $('#staticBackdrop').modal('hide');
        checkEditButtonClick = false;
        document.getElementById("myForm").reset();
      }else if (e.target.innerHTML == "Delete")
      {
        DeleteProuct("UsersSubAdnim",e.target.id);
      }else if (e.target.innerHTML == "remove")
      {
        
        ChangeImage('Are you sure you want to remove this Image?',e,false);
        
      }else if (e.target.innerHTML == "Update Image"){

        ChangeImage('Are you sure you want to upload a Image?',e,true);
 
      }else if (e.target.innerHTML == "Close"){
        
        if (checkEditButtonClick){
        removeAndShowElement(['newId0'],"",true);
        checkEditButtonClick = false;
        removeAndShowElement(['showButton'],'block',false);
        }
        document.getElementById("CloseButton").innerHTML = "Add";
        $('#staticBackdrop').modal('hide');
        document.getElementById("myForm").reset();
      }
    })

//Run Add Validation
AddValidation();

//Add Validation
function AddValidation(){
  // Fetch all the forms we want to apply custom Bootstrap validation styles to
const forms = document.querySelectorAll('.needs-validation')
var form = forms[0];


function my_submit(ev) {
if (!form.checkValidity()) {
ev.preventDefault()
ev.stopPropagation()
} else {
form.submit()
}
form.classList.add('was-validated')
return false;
}

document.querySelector("#Submitform").addEventListener('click', my_submit)
form.addEventListener('submit', my_submit);
} 


    async function ChangeImage(mag,e,value)
    {
      
          if (value)
            selectNewImage(e.target.id);
          else
            removeImageUrl(e.target.id);
    }


    function removeImageUrl(id){

      var valueId = id.split(',');
      document.getElementById("image" + valueId[0]).src = "assets/images/no-image-icon-23492.png";
      updateNewImageToDatabase(valueId[0],"UsersSubAdnim",valueId[1],"assets/images/no-image-icon-23492.png");
    }


    //run get All product
    getAllProduct(sessionStorage.getItem("MainAdnim"));

    //run get All category
    getAllCategory("BusinessesData");
  
     //get all Date for table category
     async function getAllProduct(getProductPath){
  
        onSnapshot( collection(db, 'UsersSubAdnim'), (docSnap) => {
           var tbodyRef = document.getElementsByTagName('tbody')[0];
  
            
    
           while(tbodyRef.rows.length > 0) {
              tbodyRef.deleteRow(0);
           }

           let tab = "";
           var count = 0;
           var data  = [];
  
          docSnap.forEach(doc => {

            countLastPosition++;

            if (doc.data().MainAdnim == sessionStorage.getItem("MainAdnim"))
            {
            countLastPosition = doc.data().Position;
            count++;

            var imgUrl = '<img src= ' + doc.data().ProfileImage.toString() + ' alt= ' + doc.data().Username  + ' style="width:60px;height:70px;">';
            var Action = '<button id = ' + countLastPosition + ' type="button" class="btn btn-primary m-2" data-bs-toggle="modal" data-bs-target="#staticBackdrop">Edit</button>'
                       + '<button type="button" id = ' + countLastPosition + ' class="btn btn-danger" data-toggle="confirmation" data-title="Are your sure you want to delete this product?">Delete</button>';
                       var CategoryStatus = "";
                      
            if (doc.data().Delivery == true && doc.data().Adnim == true)
              CategoryStatus = "Delivery,Adnim";
            else if (doc.data().Adnim == true)
              CategoryStatus = "Adnim";
            else if (doc.data().Delivery == true)
              CategoryStatus = "Delivery";
            
            data.push([count,doc.data().Username,doc.data().Password,doc.data().SubStore,imgUrl,CategoryStatus,Action]);
            }
          });

          document.getElementById("addRow").innerHTML += tab;
            $(document).ready(function () {
          $('#example').DataTable({
            "bDestroy": true,
              data: data,
              columns: [
                  { title: 'Position' },
                  { title: 'Username' },
                  { title: 'Password' },
                  { title: 'Store Name' },
                  { title: 'Profile' },
                  { title: 'Status' },
                  { title: 'Action' },
            ],
          });
      });

        })
     }

     //get all Date for table category
     async function getAllCategory(categoryPath){
      
      onSnapshot( collection(db, 'BusinessesData'), (docSnap) => {
        
        docSnap.forEach(doc => {
          if (doc.data().MainAdnim == sessionStorage.getItem("MainAdnim"))
            document.getElementById("SelectCategory").innerHTML += "<option value= '" + doc.data().CompanyName.toString() +"' >" + doc.data().CompanyName + "</option>";
      });
   })
  }
    
     // Add category
     async function AddProduct(NameBus){
      
      countLastPosition++;
      var refCol = doc(db,'UsersSubAdnim', countLastPosition.toString());
      
      await setDoc( refCol, {
        MainAdnim                : sessionStorage.getItem("MainAdnim"),
        SubStore                 : SubStore.value,
        Username                 : name.value,
        Adnim                    : Status_Product.checked,
        Delivery                 : Trending_Product.checked,
        Password                 : Meta_TitleProduct.value,
        Position                 : countLastPosition,
        ProfileImage             : ImageLinksArray[0],

          }).then(() => {
            RestoreBack();
            createToast('Success', 'Record was successfully Added!', 'toast-success');
        //success("successful","category added successful");
         // name.value                     = "";            
         // ProductSlug.value              = "";                   
         // ProductShortDescription.value  = "";                               
         // ProductDescription.value       = "";                          
         // ProductOriginal.value          = "";                       
         // ProductSelling.value           = "";                      
         // ProductQuantity.value          = "";                       
         // Status_Product.value           = false;                      
         // Trending_Product.value         = false;                        
         // Meta_TitleProduct.value        = "";                         
         // Meta_Description_Product.value = "";                                
         // Meta_Keywords_Product.value    = "";                             
                                           
                  
          }).catch((error) => {
          //alert("bad " +  error);
          createToast('Danger', 'Record was not Added!', 'toast-danger');
           return;
      });
  
      
    }

    //remove item function
    function removeAndShowElement(allElementIds,value,removeBool){
      allElementIds.forEach((ElementId) => {
        if(!removeBool)
          document.getElementById(ElementId).style.display = value;
        else if (removeBool)
        document.getElementById(ElementId).remove();
      });
    }
  
    //getting 
    async function getDoumentWithGivenID(collectionName,Position){
      
      var refCol = doc(db,collectionName,Position.toString());
      
      const docSnap = await getDoc( refCol);
  
      
      
      productPosition = Position;
  
      
      
      if (docSnap.exists()){
      
          name                     .value   =  docSnap.data().Username;
          Status_Product           .checked =  docSnap.data().Adnim;
          Trending_Product         .checked =  docSnap.data().Delivery;
          Meta_TitleProduct        .value   =  docSnap.data().Password;
          ProductUploadImage[0]             = docSnap.data().ProfileImage;
          document.getElementById('imagesDiv').innerHTML              = '<div id = "newId0" class="container"><img src= ' + ProductUploadImage[0] + ' alt="Snow" style="width:33.33%" id = "image0"><button class="btn btn-danger m-1" id = ' + "0," + docSnap.data().Position + '>remove</button><button class="btn btn-success m-1" id = ' + "0," + docSnap.data().Position + ',upload >Update Image</button></div>';
          
          //imageToDelete
         
      }else
      {
        //info("The category does not exist or was not found");
      }
   
   }
   
    //updating Doc 
    async function updateDoument_GivenID(collectionPath,NameBus){
    alert("updateNewImage : " + updateNewImage );
   var refCol = doc(db,'UsersSubAdnim', productPosition.toString());
   
   updateDoc( refCol, {
        MainAdnim                : sessionStorage.getItem("MainAdnim"),
        SubStore                 : SubStore.value,
        Username                 : name.value,
        Adnim                    : Status_Product.checked,
        Delivery                 : Trending_Product.checked,
        Password                 : Meta_TitleProduct.value,

   }).then(() => {
      RestoreBack();
      //success("successful","category updated successful");
      
      //alert("category updated successful");
      
   }).catch((error) => {
      alert("bad " +  error);
      createToast('Danger', 'Rocord was not found!', 'toast-danger');
      //danger("Error","category didn't updated successful");
      
   });

}

    //delete product
    async function DeleteProuct(path,position) {

      
      const result = await b_confirm('Are you sure you want to delete this item?')
    
      
      if (!result)
        return;
        
      await getDoumentWithGivenID(path,position);
        
      const docRef = await doc(db, path, position);

      await DeleteImageOnDatabaseWithUrl(ProductUploadImage[0]);

      await deleteDoc(docRef)
              .then(() => {
                //alert("Entire Document has been deleted successfully.");
                createToast('Success', 'Record was deleted successfully!', 'toast-success');
              }).catch(error => {
                //alert(error);
                createToast('Danger', 'Record was not deleted!', 'toast-danger');
              });
    }

    async function b_confirm(msg) {
      const modalElem = document.createElement('div')
      modalElem.id = "modal-confirm"
      modalElem.className = "modal"
      modalElem.innerHTML = `
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">             
            <div class="modal-body fs-6">
              <p>${msg}</p>
          </div>    <!-- modal-body -->
          <div class="modal-footer" style="border-top:0px">             
            <button id="modal-btn-descartar" type="button" class="btn btn-secondary">Cancel</button>
            <button id="modal-btn-aceptar" type="button" class="btn btn-primary">Accept</button>
          </div>
        </div>
      </div>
      `
      const myModal = new bootstrap.Modal(modalElem, {
        keyboard: false,
        backdrop: 'static'
      })
      myModal.show();
      myModal.id = "DeletemyModal";
    
      return new Promise((resolve, reject) => {
        document.body.addEventListener('click', response)
    
        function response(e) {
          let bool = false
          if (e.target.id == 'modal-btn-descartar') {
            
            bool = false}
          else if (e.target.id == 'modal-btn-aceptar') {
            bool = true;}
          else return
          myModal.hide();
          document.body.removeEventListener('click', response);
          //document.body.querySelector('.modal-backdrop').remove();
          modalElem.remove();
          //document.body.querySelector('.modal-backdrop').remove();
          resolve(bool)
        }
      })
    }
   
    function OpenFileDialog(){
      let inp      = document.createElement("input");
      inp.type     = "file";
      
      inp.onchange = (e) => {
        AssignImagesToFilesArray(e.target.files);
        CreateImageTags();
      }
      
      inp.click();
    }
  
    function AssignImagesToFilesArray(thefile){
      let num     = Files.length + thefile.length;
      let looplim = (num <= 4) ? thefile.length : (10 - Files.length)
      
      Files.push(thefile[looplim - 1]);
      
      
      if (num > 1) 
        createToast('Danger', 'Maximun 1 images is allowed!', 'toast-danger');
        //alert("Maximun 3 images are allowed");
    }
    
    function CreateImageTags(){
      imagesDiv.innerHTML = "";
      imagesDiv.classList.add('imagesDivcStyle');
      
      
      for (let i = 0; i < Files.length; i++){
        FileReaders[i] = new FileReader();
        
        FileReaders[i].onload = function(){
          if (document.getElementById('imgNo0') == null)
          {
          var img = document.createElement("img");
          img.id  = "imgNo" + i;
          img.classList.add('imgs');
          img.src = FileReaders[i].result;
          img.width = 60;
          img.height = 60;
          imagesDiv.append(img);
          }else{
            document.getElementById('imgNo0').src = FileReaders[i].result;
          }
        }
          FileReaders[i].readAsDataURL(Files[i]);
      }
      
    }
  
    function clearImages(){
    
    Files = [];
    ImageLinksArray = [];
    imgdiv.innerHTML = "";
    imgdiv.classList.remove('imagesDivcStyle');
    
    
  }
  
  function getShortTitle(){
    let namey = name.value.substring(0,50);
    
    return namey.replace(/[^a-zA-Z0-9]/g,"");
  }
  
  function GetImagUploadProgress(){
    return "Image Uploaded " + ImageLinksArray.length + " of " + Files.length;
  }
  
  function IsAllImageUploaded(){
  
      if (ImageLinksArray.length == Files.length)
      return true;
    else
      return false;
  }
  
  function GetPoints(){
    let points = [];
    if (p1.value.length > 0) points.push(p1.value);
    if (p2.value.length > 0) points.push(p2.value);
    if (p3.value.length > 0) points.push(p3.value);
    if (p4.value.length > 0) points.push(p4.value);
    
    return points;
  }
  
  function RestoreBack(){
  
    selBtn.disabled = false;
    addBtn.disabled = false;
    
  
  }
 
  async function DeleteImageOnDatabaseWithUrl(url){

    const storage = getStorage();
    const httpsReference = sRef(storage, url);

    deleteObject(httpsReference).then(() => {
      // File deleted successfully
      //alert("File deleted successfully");

    }).catch((error) => {
      //alert(error);
      createToast('Danger', 'Image was not deleted!', 'toast-danger');
    });
  }
  //--------------------------------------------------------------------------
    
    selBtn.addEventListener('click',OpenFileDialog);
    addBtn.addEventListener('click',UploadAllImage);
    
    //--------------------------------------------------------------------------
    
    function UploadAllImage(){
      selBtn.disabled = true;
      addBtn.disabled = true;
      
      ImageLinksArray = [];
      
      UploadAnImage(Files[0],0);
      
      
    }
  
    var numberOfImageLoaded = 0;
    
    function UploadAnImage(imgToUpload, imgNo){

      var uploadingButton = document.getElementById('addproductbtn');

      uploadingButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
    
      const metadata = {
        contentType: imgToUpload.type
      }
      
      const storage = getStorage();
      
      const ImageAddress = "TheImages/" + getShortTitle() + "/img#" + (imgNo + 1);
      
      const storageRef = sRef(storage,ImageAddress);
      
      const UploadTask = uploadBytesResumable(storageRef, imgToUpload, metadata);
      
      UploadTask.on("state-changed", (snapshot) => {
        
      }, (error) => {
      
        
      },
      () =>
      {
        getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) => {
          
          numberOfImageLoaded++;
          //Toast_success("Image " + ImageLinksArray.length.toString() + "was loaded successfuly");

          
        
          ImageLinksArray.push(downloadURL);
        
            if (IsAllImageUploaded()){
              uploadingButton.innerHTML = "Upload Images";
            }
          });
      }
      
      );
      
    }
  
    //
    function selectNewImage(id)
    {
      var input = document.createElement('input');

      var valueId = id.split(','); 
	
	    input.type = "file";
	    input.click();
	    input.onchange = e => {
	    	files = e.target.files;
		
		    updateImageExtention = GetFileExt(files[0]);
		    updateImageName      = getFileName(files[0]);
		    
		    reader.readAsDataURL(files[0]);
      }

      reader.onload = function(){
        
		    document.getElementById("image" + valueId[0]).src = reader.result;
        UploadProcess(valueId[0],"UsersSubAdnim",valueId[1]);
	    }
	
	 }

   //get File name 
   function getFileName(file){
	
  var temp = file.name.split('.');
  var fName = temp.slice(0,-1).join('.');
  
  return fName;
  
}

function GetFileExt(file){
	
  var temp = file.name.split('.');
  var ext = temp.slice((temp.length - 1), (temp.length));

  

  return '.' + ext[0];
  
}

  //-------------------------upload image-------------------------//
	
	async function UploadProcess(id,collectionPath,productPosition) {
	
  var ImageToUpLoad = files[0];
  
  var ImgName = updateImageName + updateImageExtention;
  
  if (!validdateName()){
   //alert("name cannot contain . # $ ....");
   createToast('Danger', 'image name contain . # $ ....!', 'toast-danger');
   return;
  }
  
  const metaData = {
    contentType: ImageToUpLoad.type
  }
  
  const storage = getStorage();
  
  const storageRef = sRef(storage , "Images/" + CompanyName.value + '/' + ImgName);

  var loadingButton = document.getElementById( id + "," + productPosition + ',upload');
  loadingButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
  
  const UploadTask = uploadBytesResumable(storageRef, ImageToUpLoad, metaData);
  
  UploadTask.on("state-changed", (snapshot) => {
    
    
  }, (error) => {
    createToast('Danger', 'Image was not uploaded!', 'toast-danger');
    //alert("error : image not uploaded");
  },
  () =>
  {
    getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) => {
      
      updateNewImage = downloadURL;
      loadingButton.innerHTML = 'Update Image';
      
      var deleteUrl = ProductUploadImage[parseInt(id)];
      DeleteImageOnDatabaseWithUrl(deleteUrl);
      //updateNewImageToDatabase(id,collectionPath,productPosition,downloadURL);
      
      });
  }
  
  );
  
}
var updateNewImage;


function updateNewImageToDatabase(id,collectionPath,productPosition,downloadURL)
{
  var refCol = doc(db,collectionPath, productPosition.toString());
      if (id.toString() == "0")
      {
        updateDoc( refCol, {
          url : downloadURL,
        }).then(() => {
          //RestoreBack();
          createToast('Success', 'Image updated successful!', 'toast-success');
        }).catch((error) => {
          //alert("bad " +  error);
          createToast('Danger', 'Image was not updated successful!!', 'toast-danger');
          //danger("Error","category didn't updated successful");
        });

      }else if (id.toString() == "1"){
        updateDoc( refCol, {
          url1 : downloadURL,
        }).then(() => {
          //RestoreBack();
          createToast('Success', 'Image updated successful!', 'toast-success');
        }).catch((error) => {
          //alert("bad " +  error);
          //danger("Error","category didn't updated successful");
        });

      }else if (id.toString() == "2"){
        updateDoc( refCol, {
          url2 : downloadURL,
        }).then(() => {
          //RestoreBack();
          //createToast('Success', 'Image updated successful!', 'toast-success');
        }).catch((error) => {
          //alert("bad " +  error);
          //danger("Error","category didn't updated successful");
        });

      }
    
}

function validdateName() {
	var regex = /[\.#$\[\]]/;
	
	return !(regex.test(namebox.value));
	
	}

  function createToast(title, message, toastId) {
      // Create a new Toast element
      var toast = document.createElement('div');
      toast.className = 'toast';
      toast.classList.add(toastId);
      toast.id = toastId;
      toast.style.position = 'absolute';
      toast.style.top = '1rem';
      toast.style.right = '1rem';

      // Create the Toast's content
      var toastHeader = document.createElement('div');
      toastHeader.className = 'toast-header text-white';
      var titleElement = document.createElement('strong');
      titleElement.className = 'mr-auto';
      titleElement.textContent = title;
      toastHeader.appendChild(titleElement);
      

      var toastBody = document.createElement('div');
      toastBody.className = 'toast-body';
      toastBody.textContent = message;

      toast.appendChild(toastHeader);
      toast.appendChild(toastBody);

      // Append the Toast to the container
      document.getElementById('toastContainer').appendChild(toast);

      // Show the Toast
      var toastInstance = new bootstrap.Toast(toast);
      toastInstance.show();
    }
 

  </script>

</html>